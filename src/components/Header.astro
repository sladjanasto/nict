---
import { getUITranslations, getLangFromUrl, getLanguageSwitchUrls } from '../utils/i18n.ts';

const { url } = Astro;
const lang = getLangFromUrl(url);
const ui = await getUITranslations(lang);
const languageSwitchUrls = getLanguageSwitchUrls(url.pathname) || [];

// Check if we're on the blog page or a blog post
const isBlogPage = url.pathname.startsWith('/blog');
const isHomePage = url.pathname === '/' || url.pathname === `/${lang}` || url.pathname === `/${lang}/`;

// Generate appropriate links based on current page
const homeLink = isHomePage ? '#home' : '/';
const servicesLink = isHomePage ? '#services' : '/#services';
const aboutLink = isHomePage ? '#about' : '/#about';
const contactLink = isBlogPage ? '#contact' : (isHomePage ? '#contact' : '/#contact');
---

<header class="header" transition:persist>
	<div class="container">
		<nav class="navbar">
			<div class="nav-brand">
				<a href="/" class="logo">
					<img src="/NICT_logo_color2.svg" alt="N-ICT - drop IT on us" class="logo-img" />
				</a>
			</div>
			
			<div class="nav-menu" id="nav-menu">
				<ul class="nav-list">
					<li class="nav-item">
						<a href={homeLink} class="nav-link">
							<i class="icon icon-home"></i>
							<span class="nav-text">{ui.nav.home}</span>
						</a>
					</li>
					<li class="nav-item">
						<a href={servicesLink} class="nav-link">
							<i class="icon icon-cogs"></i>
							<span class="nav-text">{ui.nav.services}</span>
						</a>
					</li>
					<li class="nav-item">
						<a href={aboutLink} class="nav-link">
							<i class="icon icon-user-tie"></i>
							<span class="nav-text">{ui.nav.about}</span>
						</a>
					</li>
					<!-- <li class="nav-item">
						<a href="/blog" class="nav-link">
							<i class="icon icon-pen"></i>
							<span class="nav-text">{ui.nav.blog}</span>
						</a>
					</li> -->
				</ul>
				
				<div class="nav-actions">
					<!-- Language Flags -->
					<div class="language-flags">
						{languageSwitchUrls.map(({ lang: switchLang, label, url }) => (
							<a 
								href={url} 
								class={`flag-link ${switchLang === lang ? 'active' : ''}`}
								aria-label={`Switch to ${label}`}
								title={label}
							>
								<img 
									src={switchLang === 'en' ? '/united-kingdom.png' : '/germany.png'} 
									alt={`${label} flag`}
									class="flag-image"
								/>
							</a>
						))}
					</div>
					
					<a href={contactLink} class="btn nav-cta">
						<i class="icon icon-bubbles4"></i>
						<span class="nav-text">{ui.buttons.freeConsultation}</span>
					</a>
					
					<!-- Options Menu -->
					<div class="options-menu">
						<button 
							class="options-toggle" 
							aria-label="More options"
							aria-expanded="false"
							aria-haspopup="true"
							type="button"
						>
							<span class="options-icon" aria-hidden="true">⋮</span>
						</button>
						<div class="options-dropdown" role="menu">
							<div class="options-item" role="menuitem">
								<span class="option-label">Theme</span>
								<button 
									class="theme-toggle" 
									aria-label="Toggle dark theme"
									type="button"
								>
									<span class="theme-icon" aria-hidden="true">🌙</span>
								</button>
							</div>
							<div class="options-item" role="menuitem">
								<span class="option-label">Colors</span>
								<div class="color-scheme-selector">
									<button class="color-scheme-btn active" data-scheme="scheme-1" aria-label="Teal & Blue theme">
										<div class="color-preview">
											<span class="color-dot scheme-1-primary"></span>
											<span class="color-dot scheme-1-secondary"></span>
										</div>
									</button>
									<button class="color-scheme-btn" data-scheme="scheme-2" aria-label="Purple & Pink theme">
										<div class="color-preview">
											<span class="color-dot scheme-2-primary"></span>
											<span class="color-dot scheme-2-secondary"></span>
										</div>
									</button>
									<button class="color-scheme-btn" data-scheme="scheme-3" aria-label="Orange & Red theme">
										<div class="color-preview">
											<span class="color-dot scheme-3-primary"></span>
											<span class="color-dot scheme-3-secondary"></span>
										</div>
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Mobile hamburger button -->
			<button class="nav-toggle" aria-label="Toggle navigation menu" type="button">
				<span class="hamburger">
					<span class="bar"></span>
					<span class="bar"></span>
					<span class="bar"></span>
				</span>
			</button>
		</nav>
	</div>
</header>

<!-- Fixed Free Consultation Button -->
<div class="fixed-consultation-btn">
	<a href={contactLink} class="btn-consultation-fixed" aria-label="Free Consultation">
		<i class="icon icon-bubbles4"></i>
		<span class="consultation-text">{ui.buttons?.freeConsultation || 'Free Consultation'}</span>
	</a>
</div>

<style>
	/* Fixed Free Consultation Button */
	.fixed-consultation-btn {
		position: fixed;
		right: 20px;
		top: 50%;
		transform: translateY(-50%);
		z-index: 9998;
		opacity: 0;
		visibility: hidden;
		transition: all 0.3s ease-in-out;
	}
	
	.fixed-consultation-btn.visible {
		opacity: 1;
		visibility: visible;
	}
	
	.btn-consultation-fixed {
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--bg-gradient);
		color: white;
		padding: var(--spacing-md);
		border-radius: var(--radius-md);
		text-decoration: none;
		font-weight: 600;
		box-shadow: 0 4px 20px rgba(26, 234, 226, 0.3);
		transition: all var(--transition-normal);
		border: none;
		cursor: pointer;
		width: 48px;
		height: 48px;
	}
	
	.btn-consultation-fixed:hover {
		transform: translateY(-2px);
		box-shadow: 0 8px 30px rgba(26, 234, 226, 0.4);
		color: white;
	}
	
	.btn-consultation-fixed .icon {
		font-size: 1.2rem;
		flex-shrink: 0;
	}
	
	.consultation-text {
		display: none;
	}
	
	/* Mobile styles for fixed button */
	@media (max-width: 768px) {
		.fixed-consultation-btn {
			right: 15px;
		}
		
		.btn-consultation-fixed {
			width: 44px;
			height: 44px;
			padding: var(--spacing-sm);
		}
		
		.btn-consultation-fixed .icon {
			font-size: 1.1rem;
		}
	}
	
	@media (max-width: 480px) {
		.fixed-consultation-btn {
			right: 10px;
		}
		
		.btn-consultation-fixed {
			width: 40px;
			height: 40px;
			padding: var(--spacing-xs);
		}
		
		.btn-consultation-fixed .icon {
			font-size: 1rem;
		}
	}

	.header {
		background: var(--bg-primary);
		box-shadow: var(--shadow-md);
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		z-index: 9999; /* Increased z-index for View Transitions compatibility */
		backdrop-filter: blur(10px);
		transform: translateY(0);
		transition: transform 0.3s ease-in-out;
		/* Ensure header stays visible during View Transitions */
		view-transition-name: site-header;
	}
	
	.header.header-hidden {
		transform: translateY(-100%);
	}
	
	.navbar {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.25rem 1rem;
	}
	
	.nav-brand .logo {
		display: flex;
		align-items: center;
		text-decoration: none;
		color: var(--text-dark);
		font-weight: 700;
		font-size: var(--font-size-xl);
		outline: none;
		border: none;
	}
	
	.nav-brand .logo:focus {
		outline: none;
		border: none;
	}
	
	.logo-img {
		height: 70px;
		width: auto;
		object-fit: contain;
		border: none;
		outline: none;
	}
	
	.nav-menu {
		display: flex;
		align-items: center;
		gap: var(--spacing-md);
	}
	
	.nav-link {
		display: flex;
		align-items: center;
		gap: var(--spacing-xs);
		text-decoration: none;
		color: var(--text-primary);
		font-weight: 500;
		padding: var(--spacing-sm) var(--spacing-md);
		border-radius: var(--radius-sm);
		transition: all var(--transition-fast);
	}
	
	.nav-link:hover {
		background: var(--bg-primary);
		color: var(--gradient-mid-blue);
	}
	
	.nav-link .icon {
		font-size: var(--font-size-md);
		line-height: 1;
	}
	
	.nav-actions {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
	}
	
	/* Language Flags Styles */
	.language-flags {
		display: flex;
		align-items: center;
		gap: var(--spacing-xs);
	}
	
	.flag-link {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		border-radius: 6px;
		text-decoration: none;
		font-size: 18px;
		transition: all var(--transition-normal);
		border: 2px solid transparent;
		background: var(--bg-secondary);
		overflow: hidden;
	}
	
	.flag-image {
		width: 24px;
		height: 18px;
		object-fit: cover;
		border-radius: 2px;
		transition: transform var(--transition-normal);
	}
	
	.flag-link:hover {
		transform: scale(1.1);
		border-color: var(--primary-color);
		box-shadow: 0 2px 8px rgba(26, 234, 226, 0.2);
	}
	
	.flag-link:hover .flag-image {
		transform: scale(1.05);
	}
	
	.flag-link.active {
		background: var(--bg-primary);
	}
	
	/* Options Menu Styles */
	.options-menu {
		position: relative;
		display: flex;
		align-items: center;
	}
	
	.options-toggle {
		background: var(--bg-primary);
		border: 1px solid var(--border-color);
		border-radius: 8px;
		padding: 0.5rem;
		cursor: pointer;
		transition: all var(--transition-normal);
		display: flex;
		align-items: center;
		justify-content: center;
		width: 36px;
		height: 36px;
	}
	
	.options-toggle:hover {
		border-color: var(--primary-color);
		background: var(--bg-secondary);
	}
	
	.options-icon {
		font-size: 18px;
		color: var(--text-dark);
		font-weight: bold;
		line-height: 1;
	}
	
	.options-dropdown {
		position: absolute;
		top: calc(100% + 8px);
		right: 0;
		background: var(--bg-primary); /* Fixed: use consistent background variable */
		border: 1px solid var(--text-light);
		border-radius: 12px;
		box-shadow: var(--shadow-lg);
		padding: var(--spacing-sm);
		min-width: 200px;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px) scale(0.95);
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		z-index: 10000; /* Higher z-index for dropdown */
		backdrop-filter: blur(8px);
		/* Ensure dropdown persists during View Transitions */
		view-transition-name: options-dropdown;
	}
	
	.options-menu.active .options-dropdown {
		opacity: 1;
		visibility: visible;
		transform: translateY(0) scale(1);
	}
	
	.options-item {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: var(--spacing-sm);
		border-radius: 8px;
		transition: background-color var(--transition-normal);
	}
	
	.options-item:hover {
		background: var(--bg-secondary);
	}
	
	.options-item:not(:last-child) {
		border-bottom: 1px solid var(--border-light);
		margin-bottom: var(--spacing-xs);
		padding-bottom: var(--spacing-sm);
	}
	
	.option-label {
		font-family: 'Poppins', sans-serif;
		font-size: var(--font-size-sm);
		font-weight: 500;
		color: var(--text-dark);
	}
	
	.options-item .theme-toggle {
		background: var(--bg-primary);
		border: 1px solid var(--border-color);
		border-radius: 6px;
		padding: 0.25rem 0.5rem;
		cursor: pointer;
		transition: all var(--transition-normal);
		display: flex;
		align-items: center;
		justify-content: center;
		min-width: 40px;
		height: 32px;
		position: relative;
		overflow: hidden;
	}
	
	.options-item .theme-toggle:hover {
		border-color: var(--primary-color);
		background: var(--bg-secondary);
		transform: scale(1.05);
	}
	
	.options-item .theme-toggle:active {
		transform: scale(0.98);
	}
	
	.theme-icon {
		font-size: 14px;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	}
	
	/* Add a subtle animation when theme changes */
	.options-item .theme-toggle:focus {
		outline: 2px solid var(--primary-color);
		outline-offset: 2px;
	}
	
	/* Color Scheme Selector Styles */
	.color-scheme-selector {
		display: flex;
		gap: var(--spacing-xs);
		align-items: center;
	}
	
	.color-scheme-btn {
		background: var(--bg-primary);
		border: 2px solid transparent;
		border-radius: 8px;
		padding: 4px;
		cursor: pointer;
		transition: all var(--transition-normal);
		position: relative;
	}
	
	.color-scheme-btn:hover {
		border-color: var(--primary-color);
		transform: scale(1.05);
	}
	
	.color-scheme-btn.active {
		border-color: var(--primary-color);
		box-shadow: 0 0 0 2px rgba(26, 234, 226, 0.2);
	}
	
	.color-preview {
		display: flex;
		gap: 2px;
	}
	
	.color-dot {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		border: 1px solid rgba(255, 255, 255, 0.2);
	}
	
	.nav-list {
		display: flex;
		list-style: none;
		gap: var(--spacing-md);
		margin: 0;
	}
	
	.nav-link {
		text-decoration: none;
		color: var(--text-dark);
		font-family: 'Poppins', sans-serif;
		font-weight: 300;
		font-size: var(--font-size-base);
		transition: color var(--transition-normal);
		position: relative;
	}
	
	.nav-link:hover {
		color: var(--primary-color);
	}
	
	.nav-link::after {
		content: '';
		position: absolute;
		bottom: -5px;
		left: 0;
		width: 0;
		height: 2px;
		background: var(--bg-gradient);
		transition: width var(--transition-normal);
	}
	
	.nav-link:hover::after {
		width: 100%;
	}
	
	.nav-cta {
		font-size: var(--font-size-xs);
		font-family: 'Poppins', sans-serif;
		font-weight: 500;
		padding: var(--spacing-xs) var(--spacing-sm);
		background: var(--bg-gradient);
		color: white;
		text-decoration: none;
		border-radius: 6px;
		border: none;
		outline: none;
		transition: all var(--transition-normal);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		min-width: auto;
		white-space: nowrap;
	}
	
	.theme-toggle {
		background: none;
		border: none;
		font-size: 1.2rem;
		cursor: pointer;
		padding: 0.5rem;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all var(--transition-normal);
		color: var(--text-dark);
	}
	
	.theme-toggle:hover {
		background: rgba(26, 234, 226, 0.1);
		transform: scale(1.1);
	}
	
	[data-theme="dark"] .theme-toggle .theme-icon::before {
		content: "☀️";
	}
	
	[data-theme="light"] .theme-toggle .theme-icon::before {
		content: "🌙";
	}
	
	.theme-icon {
		display: block;
	}
	
	.theme-icon::before {
		content: "🌙";
	}
	
	.nav-cta:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		color: white;
	}
	
	/* Hamburger Menu */
	.nav-toggle {
		display: none;
		background: none;
		border: none;
		cursor: pointer;
		padding: var(--spacing-xs);
		border-radius: var(--radius-sm);
		transition: background-color var(--transition-normal);
	}
	
	.nav-toggle:hover {
		background: var(--bg-secondary);
	}
	
	.hamburger {
		width: 24px;
		height: 18px;
		position: relative;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}
	
	.bar {
		width: 100%;
		height: 2px;
		background: var(--text-dark);
		border-radius: 1px;
		transition: all 0.3s ease;
		transform-origin: center;
	}
	
	/* Hamburger animation when active */
	.nav-toggle.active .bar:nth-child(1) {
		transform: rotate(45deg) translate(6px, 6px);
	}
	
	.nav-toggle.active .bar:nth-child(2) {
		opacity: 0;
	}
	
	.nav-toggle.active .bar:nth-child(3) {
		transform: rotate(-45deg) translate(6px, -6px);
	}
	
	
	.nav-toggle {
		display: none;
	}
	
	.bar {
		display: none;
	}
	
	/* Tablet Styles */
	@media (min-width: 769px) and (max-width: 1024px) {
		/* .header {
			padding: var(--spacing-tablet) 0;
		} */
		
		.nav-list {
			gap: var(--spacing-tablet);
		}
		
		.nav-link {
			font-size: var(--font-size-base);
		}
		
		.nav-cta {
			padding: 12px 20px;
			font-size: var(--font-size-sm);
		}
	}
	
	@media (max-width: 768px) {
		.header {
			padding: var(--spacing-xs) 0;
		}
		
		.header .container {
			padding: 0;
			margin: 0;
			max-width: 100%;
			width: 100%;
		}
		
		.navbar {
			flex-direction: row;
			align-items: center;
			justify-content: space-between;
			gap: var(--spacing-xs);
			width: 100%;
			padding: 0 var(--spacing-md);
		}
		
		.nav-brand {
			flex: 0 0 auto;
		}
		
		.logo-img {
			height: 40px;
		}
		
		/* Show hamburger, hide menu by default */
		.nav-toggle {
			display: block;
			order: 3;
		}
		
		.nav-menu {
			position: fixed;
			top: 100%;
			left: 0;
			right: 0;
			background: var(--bg-primary);
			border-top: 1px solid var(--border-light);
			box-shadow: var(--shadow-lg);
			transform: translateY(-100%);
			opacity: 0;
			visibility: hidden;
			transition: all 0.3s ease-in-out;
			z-index: 9997;
			max-height: calc(100vh - 80px);
			overflow-y: auto;
			flex-direction: column;
			padding: var(--spacing-lg) 0;
		}
		
		.nav-menu.active {
			transform: translateY(0);
			opacity: 1;
			visibility: visible;
		}
		
		.nav-list {
			display: flex;
			flex-direction: column;
			gap: 0;
			justify-content: center;
			margin: 0 0 var(--spacing-lg) 0;
			padding: 0;
		}
		
		.nav-link {
			flex-direction: row;
			gap: var(--spacing-md);
			padding: var(--spacing-md) var(--spacing-lg);
			text-align: left;
			min-width: auto;
			max-width: none;
			border-bottom: 1px solid var(--border-light);
		}
		
		.nav-link .icon {
			font-size: 1.2rem;
			color: var(--primary-color);
		}
		
		.nav-link:hover .icon {
			color: var(--secondary-color);
		}
		
		.nav-text {
			display: block;
			font-size: var(--font-size-base);
		}
		
		.nav-actions {
			flex-direction: column;
			gap: var(--spacing-md);
			align-items: center;
			width: 100%;
			padding: 0 var(--spacing-lg);
		}
		
		.language-flags {
			order: 1;
			justify-content: center;
		}
		
		.flag-link {
			width: 28px;
			height: 28px;
			font-size: 16px;
		}
		
		.flag-image {
			width: 20px;
			height: 15px;
		}
		
		.nav-cta {
			order: 2;
			padding: var(--spacing-md) var(--spacing-lg);
			font-size: var(--font-size-base);
			border-radius: var(--radius-md);
			width: 100%;
			max-width: 280px;
			justify-content: center;
		}
		
		.nav-cta .nav-text {
			display: block;
		}
		
		.nav-cta .icon {
			font-size: 1.1rem;
		}
		
		.options-menu {
			order: 3;
			display: none; /* Hide on mobile for now */
		}
		
		.options-dropdown {
			right: 0;
			min-width: 200px;
		}
	}
	
	/* Extra small screens */
	@media (max-width: 480px) {
		.navbar {
			padding: 0 var(--spacing-xs);
		}
		
		.logo-img {
			height: 35px;
		}
		
		.nav-list {
			gap: var(--spacing-md);
		}
		
		.nav-link {
			min-width: 35px;
			max-width: 45px;
			padding: var(--spacing-xs);
		}
		
		.nav-link .icon {
			font-size: 1.1rem;
		}
		
		.nav-cta {
			padding: var(--spacing-xs);
		}
		
		.nav-cta .icon {
			font-size: 1rem;
		}
		
		.options-menu {
			display: none; /* Hide on small mobile for now */
		}
	}
			min-width: 200px;
		}
			font-size: var(--font-size-xs);
		}
		
		.nav-cta .nav-text {
			display: none;
		}
		
		.nav-cta .icon {
			font-size: var(--font-size-lg);
		}
		}
		
		.language-switcher {
			order: 1;
		}
		
		.nav-list {
			overflow-x: auto;
			flex-wrap: nowrap;
			gap: 0;
			padding: 0 var(--spacing-sm);
			scrollbar-width: none; /* Firefox */
			-ms-overflow-style: none; /* IE/Edge */
		}
		
		.nav-list::-webkit-scrollbar {
			display: none; /* Chrome/Safari */
		}
		
		.nav-item {
			flex: 0 0 auto;
			white-space: nowrap;
		}
		
		.nav-cta {
			order: 2;
			font-size: var(--font-size-xs);
			padding: var(--spacing-xs) var(--spacing-sm);
		}

		/* Options menu mobile adjustments */
		.options-dropdown {
			right: -10px;
			min-width: 180px;
		}

		.options-item {
			padding: var(--spacing-xs);
		}

		.option-label {
			font-size: var(--font-size-xs);
		}

		.options-item .lang-select {
			min-width: 70px;
			font-size: var(--font-size-xs);
		}

		.options-item .theme-toggle {
			min-width: 35px;
			height: 28px;
		}
	}
	
	/* Color Scheme Dots */
	.scheme-1-primary {
		background: #1aeae2 !important;
	}
	
	.scheme-1-secondary {
		background: #2566cf !important;
	}
	
	.scheme-2-primary {
		background: #a855f7 !important;
	}
	
	.scheme-2-secondary {
		background: #ec4899 !important;
	}
	
	.scheme-3-primary {
		background: #f97316 !important;
	}
	
	.scheme-3-secondary {
		background: #dc2626 !important;
	}
</style>

<script>
	// Fixed consultation button show/hide on scroll
	const fixedConsultationBtn = document.querySelector('.fixed-consultation-btn');
	const showButtonThreshold = 200; // Show button after 200px scroll
	
	function handleFixedButtonScroll() {
		const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
		
		// Show button when scrolled down, hide when at the top
		if (scrollTop > showButtonThreshold) {
			fixedConsultationBtn?.classList.add('visible');
		} else {
			fixedConsultationBtn?.classList.remove('visible');
		}
	}
	
	// Header hide/show on scroll
	let lastScrollTop = 0;
	const header = document.querySelector('.header');
	const scrollThreshold = 100; // Minimum scroll distance before hiding header
	
	function handleScroll() {
		const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
		
		// Don't hide header if we're at the very top
		if (scrollTop <= scrollThreshold) {
			header?.classList.remove('header-hidden');
			return;
		}
		
		// Hide header when scrolling down, show when scrolling up
		if (scrollTop > lastScrollTop) {
			// Scrolling down
			header?.classList.add('header-hidden');
		} else {
			// Scrolling up
			header?.classList.remove('header-hidden');
		}
		
		lastScrollTop = scrollTop;
	}
	
	// Throttle scroll events for better performance
	let ticking = false;
	function throttledScroll() {
		if (!ticking) {
			requestAnimationFrame(() => {
				handleScroll();
				handleFixedButtonScroll();
				ticking = false;
			});
			ticking = true;
		}
	}
	
	window.addEventListener('scroll', throttledScroll);
	
	// Options menu functionality
	const optionsToggle = document.querySelector('.options-toggle') as HTMLButtonElement;
	const optionsMenu = document.querySelector('.options-menu') as HTMLElement;
	const optionsDropdown = document.querySelector('.options-dropdown') as HTMLElement;
	
	if (optionsToggle && optionsMenu && optionsDropdown) {
		// Toggle options menu
		optionsToggle.addEventListener('click', (e) => {
			e.stopPropagation();
			const isActive = optionsMenu.classList.toggle('active');
			
			// Update ARIA attributes
			optionsToggle.setAttribute('aria-expanded', isActive.toString());
			
			// Focus management
			if (isActive) {
				const firstFocusable = optionsDropdown.querySelector('button, select') as HTMLElement;
				firstFocusable?.focus();
			}
		});
		
		// Keyboard navigation for options menu
		optionsDropdown.addEventListener('keydown', (e) => {
			const focusableElements = optionsDropdown.querySelectorAll('button, select') as NodeListOf<HTMLElement>;
			const focusedIndex = Array.from(focusableElements).indexOf(document.activeElement as HTMLElement);
			
			switch (e.key) {
				case 'ArrowDown':
					e.preventDefault();
					const nextIndex = (focusedIndex + 1) % focusableElements.length;
					focusableElements[nextIndex]?.focus();
					break;
				case 'ArrowUp':
					e.preventDefault();
					const prevIndex = (focusedIndex - 1 + focusableElements.length) % focusableElements.length;
					focusableElements[prevIndex]?.focus();
					break;
				case 'Tab':
					// Allow normal tab behavior but close menu when tabbing out
					if (e.shiftKey && focusedIndex === 0) {
						// Shift+Tab from first element
						closeOptionsMenu();
					} else if (!e.shiftKey && focusedIndex === focusableElements.length - 1) {
						// Tab from last element
						closeOptionsMenu();
					}
					break;
			}
		});
		
		// Close options menu when clicking outside
		document.addEventListener('click', (e) => {
			if (!optionsMenu.contains(e.target as Node)) {
				closeOptionsMenu();
			}
		});
		
		// Close options menu when pressing Escape
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && optionsMenu.classList.contains('active')) {
				closeOptionsMenu();
				optionsToggle.focus();
			}
		});
	}
	
	// Color Scheme Functionality
	const colorSchemeButtons = document.querySelectorAll('.color-scheme-btn') as NodeListOf<HTMLButtonElement>;
	
	// Load saved color scheme or default to scheme-1
	const savedColorScheme = localStorage.getItem('color-scheme') || 'scheme-1';
	document.documentElement.setAttribute('data-color-scheme', savedColorScheme);
	
	// Update active button on load
	colorSchemeButtons.forEach(btn => {
		btn.classList.toggle('active', btn.getAttribute('data-scheme') === savedColorScheme);
	});
	
	// Color scheme switching
	colorSchemeButtons.forEach(button => {
		button.addEventListener('click', () => {
			const scheme = button.getAttribute('data-scheme');
			if (scheme) {
				// Update active state
				colorSchemeButtons.forEach(btn => btn.classList.remove('active'));
				button.classList.add('active');
				
				// Apply color scheme with smooth transition
				document.documentElement.style.transition = 'all 0.3s ease';
				document.documentElement.setAttribute('data-color-scheme', scheme);
				
				// Save to localStorage
				localStorage.setItem('color-scheme', scheme);
				
				// Remove transition after animation
				setTimeout(() => {
					document.documentElement.style.transition = '';
				}, 300);
			}
		});
	});
	
	function closeOptionsMenu() {
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && optionsMenu.classList.contains('active')) {
				closeOptionsMenu();
				optionsToggle.focus(); // Return focus to toggle button
			}
		});
		
		function closeOptionsMenu() {
			optionsMenu.classList.remove('active');
			optionsToggle.setAttribute('aria-expanded', 'false');
		}
	}
	
	// Theme toggle functionality
	const themeToggle = document.querySelector('.theme-toggle') as HTMLButtonElement;
	const themeIcon = document.querySelector('.theme-icon') as HTMLElement;
	
	if (themeToggle && themeIcon) {
		// Check for saved theme or default to light
		const savedTheme = localStorage.getItem('theme') || 'light';
		document.documentElement.setAttribute('data-theme', savedTheme);
		updateThemeIcon(savedTheme);
		
		themeToggle.addEventListener('click', () => {
			const currentTheme = document.documentElement.getAttribute('data-theme');
			const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
			
			document.documentElement.setAttribute('data-theme', newTheme);
			localStorage.setItem('theme', newTheme);
			updateThemeIcon(newTheme);
		});
	}
	
	function updateThemeIcon(theme: string) {
		if (themeIcon) {
			// Add a little rotation animation when changing themes
			themeIcon.style.transform = 'rotate(180deg) scale(0.8)';
			
			setTimeout(() => {
				themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
				themeIcon.style.transform = 'rotate(0deg) scale(1)';
			}, 150);
		}
	}
	
	// Smooth scrolling for anchor links
	document.querySelectorAll('a[href^="#"]').forEach((anchor: Element) => {
		(anchor as HTMLAnchorElement).addEventListener('click', (e: Event) => {
			e.preventDefault();
			const href = (anchor as HTMLAnchorElement).getAttribute('href');
			if (href) {
				const target = document.querySelector(href);
				if (target) {
					target.scrollIntoView({
						behavior: 'smooth',
						block: 'start'
					});
				}
			}
		});
	});
	
	// Mobile hamburger menu functionality
	const navToggle = document.querySelector('.nav-toggle') as HTMLButtonElement;
	const navMenu = document.querySelector('.nav-menu') as HTMLElement;
	
	if (navToggle && navMenu) {
		navToggle.addEventListener('click', () => {
			const isActive = navMenu.classList.toggle('active');
			navToggle.classList.toggle('active');
			navToggle.setAttribute('aria-expanded', isActive.toString());
			
			// Prevent body scroll when menu is open
			document.body.style.overflow = isActive ? 'hidden' : '';
		});
		
		// Close mobile menu when clicking on nav links
		const navLinks = navMenu.querySelectorAll('.nav-link');
		navLinks.forEach(link => {
			link.addEventListener('click', () => {
				navMenu.classList.remove('active');
				navToggle.classList.remove('active');
				navToggle.setAttribute('aria-expanded', 'false');
				document.body.style.overflow = '';
			});
		});
		
		// Close mobile menu when clicking outside
		document.addEventListener('click', (e) => {
			if (!navMenu.contains(e.target as Node) && !navToggle.contains(e.target as Node)) {
				navMenu.classList.remove('active');
				navToggle.classList.remove('active');
				navToggle.setAttribute('aria-expanded', 'false');
				document.body.style.overflow = '';
			}
		});
		
		// Close mobile menu on escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && navMenu.classList.contains('active')) {
				navMenu.classList.remove('active');
				navToggle.classList.remove('active');
				navToggle.setAttribute('aria-expanded', 'false');
				document.body.style.overflow = '';
				navToggle.focus();
			}
		});
	}
</script>