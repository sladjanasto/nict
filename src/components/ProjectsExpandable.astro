---
import { getUITranslations, getLangFromUrl, getPageContent } from '../utils/i18n.ts';

const { url } = Astro;
const lang = getLangFromUrl(url);
const ui = await getUITranslations(lang);
const portfolioContent = await getPageContent(lang, 'portfolio');

// Fallback content if markdown content is not available
const content = portfolioContent ? await portfolioContent.render() : null;

// Extract data to avoid complex expressions in template
const portfolioData = ui.portfolio || {};
const projects = portfolioData.projects || [];
const techCategories = portfolioData.technologyExpertise?.categories || [];
const techExpertiseData = portfolioData.technologyExpertise || {};
---

<section id="projects" class="projects section">
	<div class="container">
		<h2 class="section-title">{portfolioData.title || 'What we\'ve built'}</h2>
		<p class="projects-intro">
			{portfolioData.subtitle || 'Our work and results'}
		</p>
		
		{portfolioContent && (
			<div class="projects-markdown">
				<Fragment set:html={content?.Content} />
			</div>
		)}
		
		<div class="projects-grid" id="projectsGrid">
			{projects.map((project: any, index: number) => (
				<div class={`project-card ${index > 2 ? 'hidden' : ''}`} data-project-index={index}>
					<div class="project-header">
						<div class="project-meta">
							<h3 class="project-main-title">{project.title}</h3>
							{project.subtitle && <h4 class="project-subtitle">{project.subtitle}</h4>}
							<div class="project-details">
								<span class="industry">{project.industry}</span>
								{project.position && <span class="position">{project.position}</span>}
								{project.size && <span class="size">{project.size}</span>}
								{project.locations && <span class="locations">{project.locations}</span>}
								{project.monitoring && <span class="monitoring">{project.monitoring}</span>}
								{project.framework && <span class="framework">{project.framework}</span>}
								{project.duration && <span class="duration">{project.duration}</span>}
								{project.costSavings && <span class="cost-savings">{project.costSavings} Cost Savings</span>}
							</div>
						</div>
					</div>
					<div class="project-content">
						<div class="challenge">
							<h4>{portfolioData.challenge || 'Challenge'}</h4>
							<p>{project.challenge}</p>
						</div>
						
						{project.leadershipTasks && (
							<div class="leadership-tasks">
								<h4>Leadership Tasks</h4>
								<ul class="tasks-list">
									{project.leadershipTasks.map((task: string) => (
										<li>{task}</li>
									))}
								</ul>
							</div>
						)}
						
						{project.solution && (
							<div class="solution">
								<h4>Solution</h4>
								<ul class="solution-list">
									{project.solution.map((item: string) => (
										<li>{item}</li>
									))}
								</ul>
							</div>
						)}
						
						<div class="results">
							<h4>{portfolioData.results || 'Results'}</h4>
							<ul class="results-list">
								{(project.results || []).map((result: string) => (
									<li>{result}</li>
								))}
							</ul>
						</div>
						
						{project.leadershipImpact && (
							<div class="leadership-impact">
								<h4>Leadership Impact</h4>
								<p class="impact-text">{project.leadershipImpact}</p>
							</div>
						)}
					</div>
				</div>
			))}
		</div>
		
		{projects.length > 3 && (
			<div class="projects-controls">
				<button class="btn-link" id="showMoreBtn">
					<span class="btn-text-show">Show More Projects</span>
					<span class="btn-text-hide" style="display: none;">Show Less</span>
					<i class="icon icon-arrow-down"></i>
				</button>
			</div>
		)}
	</div>
</section>

<style>
	.projects {
		background: var(--bg-secondary);
		padding: var(--spacing-xxl) 0;
	}
	
	.projects-intro {
		text-align: center;
		font-size: var(--font-size-lg);
		color: var(--text-muted);
		margin-bottom: var(--spacing-3xl);
		max-width: 600px;
		margin-left: auto;
		margin-right: auto;
	}
	
	.projects-markdown {
		max-width: 800px;
		margin: 0 auto var(--spacing-3xl) auto;
		text-align: center;
	}
	
	.projects-markdown :global(h2),
	.projects-markdown :global(h3) {
		font-family: var(--font-headings);
		color: var(--gradient-mid-blue);
		margin-bottom: var(--spacing-md);
	}
	
	.projects-markdown :global(p) {
		font-size: var(--font-size-md);
		line-height: 1.7;
		color: var(--text-muted);
		margin-bottom: var(--spacing-lg);
	}
	
	.projects-grid {
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		gap: 0.5rem;
		margin-bottom: var(--spacing-3xl);
		max-width:1400px;
		margin:0% auto;
	}
	
	.project-card {
		background: var(--bg-white);
		border-radius: var(--radius-lg);
		box-shadow: var(--shadow-md);
		padding: var(--spacing-xl);
		transition: all var(--transition-normal);
		position: relative;
		overflow: hidden;
		width:25%;
	}
	
	.project-card.hidden {
		display: none;
	}
	
	.project-card:hover {
		transform: translateY(-5px);
		box-shadow: var(--shadow-xl);
	}
	
	.project-header {
		display: flex;
		align-items: flex-start;
		gap: var(--spacing-lg);
		margin-bottom: 1rem;
		border-bottom: 1px solid var(--border-light);
	}
	
	.project-icon {
		font-size: 2.5rem;
		flex-shrink: 0;
		margin-top: 0.2rem;
	}
	
	.project-meta h3 {
		font-family: var(--font-headings);
		font-size: var(--font-size-xl);
		font-weight: 600;
		color: var(--primary-color);
		margin: 0 0 var(--spacing-xs) 0;
		line-height: 1.3;
	}
	
	.project-meta .project-subtitle {
		font-family: var(--font-headings);
		font-size: var(--font-size-lg);
		font-weight: 400;
		color: var(--text-dark);
		margin: 0 0 var(--spacing-sm) 0;
		line-height: 1.2;
	}
	
	.project-details {
		display: flex;
		flex-wrap: wrap;
	}
	.project-details span:first-child{
		padding-left: 0;
	}
	
	.project-details span {
		background: var(--bg-primary);
		font-size: var(--font-size-sm);
		padding: var(--spacing-xs) var(--spacing-sm);
		border-radius: var(--radius-sm);
		font-weight: 400;
	}
	
	.project-details .cost-savings {
		background: #22c55e;
		color: white;
	}
	
	.project-details .monitoring {
		background: #f59e0b;
		color: white;
	}
	
	.project-details .framework {
		background: #8b5cf6;
		color: white;
	}
	.project-content .challenge{
		min-height: 7rem;
	}
	
	.project-content h4 {
		font-family: var(--font-headings);
		font-size: var(--font-size-md);
		font-weight: 400;
		margin: 0 0 var(--spacing-sm) 0;
		text-align:center;
		background: var(--bg-secondary)
		}
	
	.project-content p {
		font-size: 0.9rem;
		line-height: 1.6;
		color: var(--text-muted);
		margin: 0;
	}
	
	.results-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	
	.results-list li,
	.tasks-list li,
	.solution-list li {
		font-size: 0.9rem;
		line-height: 1.6;
		color: var(--text-muted);
		margin-bottom: var(--spacing-sm);
		padding-left: var(--spacing-lg);
		position: relative;
	}
	
	.results-list li::before {
		content: '✓';
		position: absolute;
		left: 0;
		top: 0;
		color: #22c55e;
		font-weight: bold;
		font-size: var(--font-size-md);
	}
	
	.tasks-list,
	.solution-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	
	.tasks-list li::before {
		content: '■';
		position: absolute;
		left: 0;
		top: 0;
		color: var(--secondary-color);
		font-weight: bold;
		font-size: var(--font-size-md);
	}
	
	.solution-list li::before {
		content: '■';
		position: absolute;
		left: 0;
		top: 0;
		color: var(--primary-color);
		font-weight: bold;
		font-size: var(--font-size-md);
	}
	
	.results-list li:last-child,
	.tasks-list li:last-child,
	.solution-list li:last-child {
		margin-bottom: 0;
	}
	
	.impact-text {
		font-size: var(--font-size-md);
		line-height: 1.6;
		color: var(--text-muted);
		font-style: italic;
		background: var(--bg-secondary);
		padding: var(--spacing-sm) var(--spacing-md);
		border-radius: var(--radius-sm);
		border-left: 3px solid var(--primary-color);
		margin: 0;
	}
	
	.projects-controls {
		text-align: center;
		margin-top: var(--spacing-xl);
	}
	
	/* Responsive Design */
	@media (max-width: 768px) {
		.projects {
			padding: var(--spacing-xl) 0;
		}
		
		.projects-intro {
			font-size: var(--font-size-md);
			margin-bottom: var(--spacing-2xl);
		}
		
		.projects-grid {
			grid-template-columns: 1fr;
			gap: var(--spacing-lg);
			margin-bottom: var(--spacing-2xl);
		}
		
		.project-card {
			padding: var(--spacing-lg);
			width:90%;
		}
		
		.project-header {
			flex-direction: column;
			align-items: center;
			text-align: center;
			gap: var(--spacing-sm);
		}
		
		.project-icon {
			font-size: 2rem;
		}
		
		.project-meta h3 {
			font-size: var(--font-size-lg);
		}
		
		.project-details {
			justify-content: center;
		}
		
		.project-details span {
			font-size: var(--font-size-xs);
		}
	}
	
	@media (min-width: 769px) and (max-width: 1024px) {
		.projects-grid {
			grid-template-columns: repeat(2, 1fr);
		}
			.project-card {
			width:40%;
		}
		
		.tech-categories {
			grid-template-columns: repeat(2, 1fr);
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const showMoreBtn = document.getElementById('showMoreBtn');
		const projectsGrid = document.getElementById('projectsGrid');
		
		if (!showMoreBtn || !projectsGrid) return;
		
		const hiddenProjects = projectsGrid.querySelectorAll('.project-card.hidden');
		const btnTextShow = showMoreBtn.querySelector('.btn-text-show') as HTMLElement;
		const btnTextHide = showMoreBtn.querySelector('.btn-text-hide') as HTMLElement;
		
		if (hiddenProjects.length === 0) {
			showMoreBtn.style.display = 'none';
			return;
		}
		
		if (!btnTextShow || !btnTextHide) return;
		
		let isExpanded = false;
		
		showMoreBtn.addEventListener('click', function() {
			isExpanded = !isExpanded;
			
			hiddenProjects.forEach(project => {
				if (isExpanded) {
					project.classList.remove('hidden');
				} else {
					project.classList.add('hidden');
				}
			});
			
			if (isExpanded) {
				btnTextShow.style.display = 'none';
				btnTextHide.style.display = 'inline';
				showMoreBtn.classList.add('expanded');
			} else {
				btnTextShow.style.display = 'inline';
				btnTextHide.style.display = 'none';
				showMoreBtn.classList.remove('expanded');
			}
			
			// Smooth scroll to maintain position
			if (!isExpanded) {
				showMoreBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}
		});
	});
</script>